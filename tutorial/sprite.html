<!DOCTYPE html>
<html lang='ja'>
<head>
<meta charset="UTF-8">
<link rel='stylesheet' type='text/css' href='../dxruby-code-highlight.css' />
<link rel='stylesheet' type='text/css' href='../dxruby.css' />
<title>Spriteを使うためのチュートリアル</title>
</head>
<body>
<header>DXRuby 1.4.2 <span class="title">Reference Manual</span></header>
<section id="document">
<section id="content">
<a href='../index.html'>TOPへ戻る</a>
<h1>Spriteを使うためのチュートリアル</h1>

<h2>目次</h2>

<ol>
<li><a href="#AUTOINDEXANCHOR_0">基本</a>

<ol>
<li><a href="#AUTOINDEXANCHOR_1">最も基本的な使い方</a></li>
<li><a href="#AUTOINDEXANCHOR_2">絵を動かす</a></li>
<li><a href="#AUTOINDEXANCHOR_3">回転など</a></li>
</ol></li>
<li><a href="#AUTOINDEXANCHOR_4">クラスの継承</a>

<ol>
<li><a href="#AUTOINDEXANCHOR_5">クラスメソッドを使う</a></li>
<li><a href="#AUTOINDEXANCHOR_6">Spriteオブジェクト以外もまとめて管理する</a></li>
<li><a href="#AUTOINDEXANCHOR_7">Spriteのライフサイクルを管理する</a></li>
<li><a href="#AUTOINDEXANCHOR_8">まとめ</a></li>
</ol></li>
<li><a href="#AUTOINDEXANCHOR_9">衝突判定</a>

<ol>
<li><a href="#AUTOINDEXANCHOR_10">衝突判定の使い方</a></li>
<li><a href="#AUTOINDEXANCHOR_11">衝突したオブジェクトを取得する</a></li>
<li><a href="#AUTOINDEXANCHOR_12">衝突コールバック機能</a></li>
<li><a href="#AUTOINDEXANCHOR_13">同じ配列同士の衝突判定</a></li>
<li><a href="#AUTOINDEXANCHOR_14">まとめ</a></li>
</ol></li>
</ol>

<hr>

<p><a name='AUTOINDEXANCHOR_0'></a></p>

<h2>基本</h2>

<p>Spriteは描画に必要なデータと描画機能を持ちます。衝突判定をこなすこともできます。<br>
これら機能の使い方や応用方法などを解説していきます。</p>

<p><a name='AUTOINDEXANCHOR_1'></a></p>

<h3>最も基本的な使い方</h3>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="n">s</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">))</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">draw</span>
<span class="k">end</span>
</code></pre>

<p>こんな感じでしょうか。<br>
Sprite.newの引数はx座標、y座標、画像データで、画像データはImage.newして直接渡しています。<br>
最低限この3つのデータがあれば、Sprite#drawで画面に絵を描画することができます。</p>

<p><a name='AUTOINDEXANCHOR_2'></a></p>

<h3>絵を動かす</h3>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="n">s</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">))</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">x</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">draw</span>
<span class="k">end</span>
</code></pre>

<p>ベタですが、このようにするとSpriteオブジェクトのx座標を1ずつ増やしていくことができます。<br>
同様にy座標も変更することができます。<br>
Spriteオブジェクトごとに別々に座標を持っているので、例えば以下のようにすると2つのキャラを別々に動かすことができます。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="n">image</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">)</span>
<span class="n">s1</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
<span class="n">s2</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">s1</span><span class="p">.</span><span class="nf">x</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">s1</span><span class="p">.</span><span class="nf">draw</span>

  <span class="n">s2</span><span class="p">.</span><span class="nf">y</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">s2</span><span class="p">.</span><span class="nf">draw</span>
<span class="k">end</span>
</code></pre>

<p><a name='AUTOINDEXANCHOR_3'></a></p>

<h3>回転など</h3>

<p>Window.draw_exの持つエフェクト機能はすべて同じ名前の代入/参照メソッドを持っていて、同様の指定方法で設定することができます。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="n">s</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">))</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">angle</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">alpha</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="nf">alpha</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">?</span> <span class="mi">255</span> <span class="p">:</span> <span class="n">s</span><span class="p">.</span><span class="nf">alpha</span> <span class="o">-</span> <span class="mi">5</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">draw</span>
<span class="k">end</span>
</code></pre>

<hr>

<p><a name='AUTOINDEXANCHOR_4'></a></p>

<h2>クラスの継承</h2>

<p>Spriteの機能はクラスを継承することでより一層便利になります。<br>
そこで今回はSpriteを継承してクラスを定義してみます。<br>
initializeで初期値を設定し、updateで移動などをさせます。<br>
updateはSpriteクラスに定義されてはいますが、中身はからっぽです。<br>
継承したクラスで上書きして使います。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="k">class</span> <span class="nc">MySprite</span> <span class="o">&lt;</span> <span class="no">Sprite</span>
  <span class="vc">@@image</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="k">super</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="vc">@@image</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">s</span> <span class="o">=</span> <span class="no">MySprite</span><span class="p">.</span><span class="nf">new</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">update</span>
  <span class="n">s</span><span class="p">.</span><span class="nf">draw</span>
<span class="k">end</span>
</code></pre>

<p>メソッドを呼び出すときはself.xのようにselfをつけて呼び出すようにすると、無駄にバグを作りこむことがなくなりますのでオススメです。<br>
また複数オブジェクトを生成して画像を共有する場合は、クラス変数にImageオブジェクトを入れておくようにするとクラス定義時に1回だけ生成されるようになりますので、速度的に有利です。<br>
initializeでImage.new/loadするとSpriteオブジェクトを作るたびに毎回新しいImageオブジェクトが生成されていまいます。</p>

<p><a name='AUTOINDEXANCHOR_5'></a></p>

<h3>クラスメソッドを使う</h3>

<p>Sprite.update、Sprite.drawを使うと複数のオブジェクトを配列に入れてまとめて管理することができます。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="k">class</span> <span class="nc">MySprite1</span> <span class="o">&lt;</span> <span class="no">Sprite</span>
  <span class="vc">@@image</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="k">super</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="vc">@@image</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">MySprite2</span> <span class="o">&lt;</span> <span class="no">Sprite</span>
  <span class="vc">@@image</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="k">super</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="vc">@@image</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="no">MySprite1</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="no">MySprite2</span><span class="p">.</span><span class="nf">new</span><span class="p">]</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>

<p><a name='AUTOINDEXANCHOR_6'></a></p>

<h3>Spriteオブジェクト以外もまとめて管理する</h3>

<p>Sprite.update、Sprite.drawはSpriteオブジェクト以外のオブジェクトが配列に入っていても、updateやdrawを呼び出そうと試みます。<br>
無くてもエラーにはならず呼ばれないだけです。<br>
したがって自作クラスのupdate/drawの定義されたオブジェクトを配列に入れておけば、Sprite以外のオブジェクトも同様に動作させることができます。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="k">class</span> <span class="nc">MySprite1</span> <span class="o">&lt;</span> <span class="no">Sprite</span>
  <span class="vc">@@image</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="k">super</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="vc">@@image</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Count</span>
  <span class="vc">@@font</span> <span class="o">=</span> <span class="no">Font</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@count</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">draw</span>
    <span class="no">Window</span><span class="p">.</span><span class="nf">draw_font</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="vi">@count</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span> <span class="vc">@@font</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="no">MySprite1</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="no">Count</span><span class="p">.</span><span class="nf">new</span><span class="p">]</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>

<p>これで何ができるのかと言うと、例えばゲームの進行を制御するオブジェクトなどを一緒に配列に入れておいて動かすとか、背景やスコアなどの描画も同様に扱ってしまうとか、そういったSpriteを継承するのが変な場合などに使えます。<br>
もちろん使わなくてもゲームは作れます。</p>

<p><a name='AUTOINDEXANCHOR_7'></a></p>

<h3>Spriteのライフサイクルを管理する</h3>

<p>Sprite#vanishという一風変わったメソッドがあります。<br>
これはSpriteオブジェクトが不要になったときに呼び出すもので、Sprite#vanishを呼び出すとSprite#vanished?がtrueになります。<br>
trueになったオブジェクトはSprite#drawを呼び出しても描画されません。<br>
また、Sprite.cleanメソッドで配列から削除することができます。</p>

<p>Sprite.cleanを毎フレーム呼び出すようにしておいて、画面から外に出たとか、キャラが破壊されて消えるときとか、なんらかの条件でキャラを消す場合にSprite#vanishを呼び出すようにすればSprite.cleanで配列から削除されますので、キャラのオブジェクトの管理が自然にできます。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="k">class</span> <span class="nc">MySprite1</span> <span class="o">&lt;</span> <span class="no">Sprite</span>
  <span class="vc">@@image</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="k">super</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">50</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">()</span> <span class="o">*</span> <span class="mi">400</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="vc">@@image</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">vanish</span> <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">&gt;</span> <span class="mi">300</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">20</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
  <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">s</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="no">MySprite1</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">20</span>
  <span class="k">end</span>

  <span class="no">Sprite</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">clean</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>

<p><a name='AUTOINDEXANCHOR_8'></a></p>

<h3>まとめ</h3>

<p>Spriteのクラスメソッドは、Spriteを継承したクラスのオブジェクトをまとめてごそっと配列に入れて扱うことを想定していて、そのような使い方をする場合に威力を発揮します。</p>

<hr>

<p><a name='AUTOINDEXANCHOR_9'></a></p>

<h2>衝突判定</h2>

<p>Spriteクラスには柔軟で高速な衝突判定機能が備わっています。<br>
キャラをたくさん動かして衝突判定する必要のある弾幕シューティングゲームや、複雑な形状での衝突判定が必要なゲームなどで使うとラクができます。</p>

<p><a name='AUTOINDEXANCHOR_10'></a></p>

<h3>衝突判定の使い方</h3>

<p>Sprite#collision=で衝突判定範囲を設定し、Sprite.check/Sprite#check/Sprite#===で判定することができます。<br>
Sprite#collision=で設定していないと画像データサイズの矩形で判定されます。<br>
今回はSprite.check/Sprite#check/Sprite#===の使い分けに焦点を当てて解説します。</p>

<p>最も簡単なのはSprite#===を使う方法です。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="n">image</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
<span class="n">font</span> <span class="o">=</span> <span class="no">Font</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">x</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_pos_x</span><span class="p">,</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_pos_y</span>

  <span class="n">s</span><span class="p">.</span><span class="nf">draw</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">draw</span>

  <span class="k">if</span> <span class="n">m</span> <span class="o">===</span> <span class="n">s</span>
    <span class="no">Window</span><span class="p">.</span><span class="nf">draw_font</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"hit!"</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Sprite#===は衝突していたらtrueを返すメソッドなので、このような形に書くことができます。<br>
また、===の右側にはSpriteオブジェクトの配列を指定することもでき、どれか1つに当たっていたらtrueが返ります。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_RED</span><span class="p">)),</span>
     <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_GREEN</span><span class="p">)),</span>
     <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_BLUE</span><span class="p">))]</span>
<span class="n">m</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">))</span>
<span class="n">font</span> <span class="o">=</span> <span class="no">Font</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">x</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_pos_x</span><span class="p">,</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_pos_y</span>

  <span class="no">Sprite</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">draw</span>

  <span class="k">if</span> <span class="n">m</span> <span class="o">===</span> <span class="n">s</span>
    <span class="no">Window</span><span class="p">.</span><span class="nf">draw_font</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"hit!"</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Sprite#===はRubyのcase～whenでの比較に使われるメソッドなので、case～whenで比較することもできます。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="n">s1</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_RED</span><span class="p">))</span>
<span class="n">s2</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_GREEN</span><span class="p">))</span>
<span class="n">s3</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_BLUE</span><span class="p">))</span>
<span class="n">m</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">))</span>
<span class="n">font</span> <span class="o">=</span> <span class="no">Font</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">x</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_pos_x</span><span class="p">,</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_pos_y</span>

  <span class="n">s1</span><span class="p">.</span><span class="nf">draw</span>
  <span class="n">s2</span><span class="p">.</span><span class="nf">draw</span>
  <span class="n">s3</span><span class="p">.</span><span class="nf">draw</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">draw</span>

  <span class="k">case</span> <span class="n">m</span>
    <span class="k">when</span> <span class="n">s1</span>
      <span class="no">Window</span><span class="p">.</span><span class="nf">draw_font</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"red hit!"</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>
    <span class="k">when</span> <span class="n">s2</span>
      <span class="no">Window</span><span class="p">.</span><span class="nf">draw_font</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"green hit!"</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>
    <span class="k">when</span> <span class="n">s3</span>
      <span class="no">Window</span><span class="p">.</span><span class="nf">draw_font</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"blue hit!"</span><span class="p">,</span> <span class="n">font</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p><a name='AUTOINDEXANCHOR_11'></a></p>

<h3>衝突したオブジェクトを取得する</h3>

<p>Sprite#===で配列を対象に判定した場合、true/falseが返るだけでどれが衝突しているのかを知ることはできません。<br>
衝突したオブジェクトを取得したい場合はSprite#checkを使います。<br>
Sprite#checkはあるSpriteオブジェクトと衝突しているオブジェクトの配列を返すメソッドです。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="n">image1</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_WHITE</span><span class="p">)</span>
<span class="n">image2</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="no">C_RED</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="no">Array</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">rand</span> <span class="o">*</span> <span class="mi">600</span><span class="p">,</span> <span class="nb">rand</span> <span class="o">*</span> <span class="mi">440</span><span class="p">,</span> <span class="n">image1</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">m</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image1</span><span class="p">)</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">x</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_pos_x</span><span class="p">,</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_pos_y</span>

  <span class="n">m</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="n">image2</span>
  <span class="k">end</span>

  <span class="no">Sprite</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">draw</span>
<span class="k">end</span>
</code></pre>

<p><a name='AUTOINDEXANCHOR_12'></a></p>

<h3>衝突コールバック機能</h3>

<p>Sprite.checkは引数に2つのオブジェクト(どちらも配列指定可)のすべての組み合わせを判定し、衝突しているオブジェクトのメソッドを呼び出します。</p>
<pre class="highlight ruby"><code><span class="no">Sprite</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="ss">:shot</span><span class="p">,</span> <span class="n">hit</span><span class="o">=</span><span class="ss">:hit</span><span class="p">)</span>
</code></pre>

<p>oとdがそれぞれ攻撃側と防御側というイメージで、衝突している組み合わせのo側のオブジェクトのshotメソッドと、d側のオブジェクトのhitメソッドが呼ばれます。<br>
3つ目と4つ目の引数でそれぞれメソッド名を変更することができます。<br>
shot/hitメソッドはそれぞれ衝突相手のオブジェクトを引数に渡してきますので、例えば衝突相手の攻撃力を取得するとかの場合に活用できます。<br>
受け取る必要はありますが、使い道が無ければ無理に使う必要はありません。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="k">class</span> <span class="nc">Box</span> <span class="o">&lt;</span> <span class="no">Sprite</span>
  <span class="vc">@@image</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="no">C_RED</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">super</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">angle</span> <span class="o">=</span> <span class="nb">rand</span> <span class="o">*</span> <span class="mi">360</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="vc">@@image</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">vanish</span> <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">&gt;</span> <span class="mi">480</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hit</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">vanish</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">m</span> <span class="o">=</span> <span class="no">Sprite</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="no">C_WHITE</span><span class="p">))</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">50</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
  <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="no">Box</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">rand</span><span class="o">*</span><span class="mi">540</span><span class="p">,</span><span class="o">-</span><span class="mi">100</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">x</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_pos_x</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_pos_y</span> <span class="o">-</span> <span class="mi">10</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">angle</span> <span class="o">-=</span> <span class="mi">5</span> <span class="k">if</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_down?</span><span class="p">(</span><span class="no">M_LBUTTON</span><span class="p">)</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">angle</span> <span class="o">+=</span> <span class="mi">5</span> <span class="k">if</span> <span class="no">Input</span><span class="p">.</span><span class="nf">mouse_down?</span><span class="p">(</span><span class="no">M_RBUTTON</span><span class="p">)</span>

  <span class="no">Sprite</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="n">m</span><span class="p">.</span><span class="nf">draw</span>
<span class="k">end</span>
</code></pre>

<p><a name='AUTOINDEXANCHOR_13'></a></p>

<h3>同じ配列同士の衝突判定</h3>

<p>画面内に描画されるすべての物体を相互に衝突判定したい時は、Sprite.checkのoだけを設定するか、oとdに同じ配列を指定します。<br>
衝突していたらそれぞれのhitメソッドが呼び出されます。</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'dxruby'</span>

<span class="k">class</span> <span class="nc">Toufu</span> <span class="o">&lt;</span> <span class="no">Sprite</span>
  <span class="vc">@@image</span> <span class="o">=</span> <span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">,[</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span><span class="mi">150</span><span class="p">])</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="k">super</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">590</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">430</span><span class="p">)</span>
    <span class="vi">@dx</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="vi">@dy</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">image</span> <span class="o">=</span> <span class="vc">@@image</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">+=</span> <span class="vi">@dx</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">+=</span> <span class="vi">@dy</span>
    <span class="vi">@dx</span> <span class="o">=</span> <span class="o">-</span><span class="vi">@dx</span> <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">or</span> <span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">&gt;</span> <span class="mi">590</span>
    <span class="vi">@dy</span> <span class="o">=</span> <span class="o">-</span><span class="vi">@dy</span> <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">or</span> <span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">&gt;</span> <span class="mi">430</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hit</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">x</span> <span class="o">-</span> <span class="n">obj</span><span class="p">.</span><span class="nf">x</span><span class="p">).</span><span class="nf">abs</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">y</span> <span class="o">-</span> <span class="n">obj</span><span class="p">.</span><span class="nf">y</span><span class="p">).</span><span class="nf">abs</span>
      <span class="vi">@dy</span> <span class="o">=</span> <span class="o">-</span><span class="vi">@dy</span>
    <span class="k">else</span>
      <span class="vi">@dx</span> <span class="o">=</span> <span class="o">-</span><span class="vi">@dx</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">s</span> <span class="o">=</span> <span class="no">Array</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="no">Toufu</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

<span class="no">Window</span><span class="p">.</span><span class="nf">loop</span> <span class="k">do</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">check</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="no">Sprite</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

  <span class="k">break</span> <span class="k">if</span> <span class="no">Input</span><span class="p">.</span><span class="nf">keyPush?</span><span class="p">(</span><span class="no">K_ESCAPE</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>

<p><a name='AUTOINDEXANCHOR_14'></a></p>

<h3>まとめ</h3>

<p>Rubyで衝突判定を処理すると大変遅くなりますが、Sprite.checkでの複数対複数のチェックはRubyで書いた場合に比べてかなり高速になります。<br>
逆に1対1の判定などをする場合は、複雑な形状の判定でないと遅くなると思います。<br>
速度が重要でなければ、ラクなように作るのがよいでしょう。</p>

<a href='../index.html'>TOPへ戻る</a>
</section>
</section>

<footer>&copy; 2009-2015 mirichi</footer>
</body>
</html>